(ns foodwich.core
  (:require [org.httpkit.server :as server]
            [foodwich.scraper :as scraper]
            [foodwich.templates :as tmplts]
            [environ.core :refer [env]]
            [cheshire.core :as json])
  (:import [java.io File])
  (:gen-class))

(def sample-data
  [{:logo "https://static.delivery.com/merchant_logo.php?id=65304", :cost-range 2, :name "St. Nicholas Fish Market", :cuisines ["Seafood"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/st-nicholas-fish-market", :id "65304", :delivery-fee 2, :delivery-min 10, :rating 4} {:logo "https://static.delivery.com/merchant_logo.php?id=68107", :cost-range 2, :name "Sushi Yu II", :cuisines ["Asian" "Japanese" "Sushi"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/sushi-yu-ii", :id "68107", :delivery-fee 0, :delivery-min 15, :rating 3.5} {:logo "https://static.delivery.com/merchant_logo.php?id=68579", :cost-range 2, :name "Tony's Pizza, Pasta & Gyro", :cuisines ["Italian" "Pizza" "Mediterranean" "Greek"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/tonys-pizza-pasta-gyro", :id "68579", :delivery-fee 0, :delivery-min 10, :rating 2.5} {:logo "https://static.delivery.com/merchant_logo.php?id=67878", :cost-range 1, :name "Pizza Haven", :cuisines ["Italian" "Pizza"], :source :delivery, :delivery-time 30, :link "https://www.delivery.com/cities/nyc/categories/restaurant/pizza-haven-broadway", :id "67878", :delivery-fee 2, :delivery-min 10, :rating 3.5} {:logo "https://static.delivery.com/merchant_logo.php?id=69735", :cost-range 2, :name "Yummy Thai", :cuisines ["Thai" "Asian"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/yummy-thai", :id "69735", :delivery-fee 0, :delivery-min 10, :rating 2.5} {:logo "https://static.delivery.com/merchant_logo.php?id=73028", :cost-range 2, :name "Pick & Eat", :cuisines ["Sandwiches" "Deli" "Burgers" "Soups"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/pick-eat", :id "73028", :delivery-fee 3, :delivery-min 10, :rating 4} {:logo "https://static.delivery.com/merchant_logo.php?id=72817", :cost-range 1, :name "El Nuevo Caridad", :cuisines ["Cuban" "Latin"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/el-nuevo-caridad", :id "72817", :delivery-fee 0, :delivery-min 12, :rating 3.5} {:logo "https://static.delivery.com/merchant_logo.php?id=73297", :cost-range 1, :name "Arturo's Pizza", :cuisines ["Italian" "Pizza"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/bronx/categories/restaurant/arturos-pizza", :id "73297", :delivery-fee 0, :delivery-min 10, :rating 3.5} {:logo "https://static.delivery.com/merchant_logo.php?id=72541", :cost-range 2, :name "Mix it Up", :cuisines ["Gluten-Free" "Healthy" "Juice Bar" "Vegetarian"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/white-plains/categories/restaurant/mix-it-up", :id "72541", :delivery-fee 6, :delivery-min 100, :rating 3.5} {:logo "https://static.delivery.com/merchant_logo.php?id=40917", :cost-range 1, :name "Amy's Restaurant Chinese & Asian Cuisine", :cuisines ["Asian" "Chinese"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/amys-restaurant-chinese-asian-cuisine", :id "40917", :delivery-fee 1, :delivery-min 15, :rating 3.5} {:logo "https://static.delivery.com/merchant_logo.php?id=73947", :cost-range 2, :name "Albert's Mofongo", :cuisines ["Spanish" "Empanadas" "Breakfast" "Burgers"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/alberts-mofongo", :id "73947", :delivery-fee 0, :delivery-min 10, :rating 3.5} {:logo "https://static.delivery.com/merchant_logo.php?id=75240", :cost-range 1, :name "Tommy's", :cuisines ["Burgers" "Italian" "Pizza" "Breakfast"], :source :delivery, :delivery-time 40, :link "https://www.delivery.com/cities/nyc/categories/restaurant/tommys", :id "75240", :delivery-fee 0, :delivery-min 15, :rating 3.5} {:logo "https://static.delivery.com/merchant_logo.php?id=60665", :cost-range 2, :name "Limon Restaurant", :cuisines ["Mediterranean" "Middle Eastern" "Halal" "Turkish"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/limon", :id "60665", :delivery-fee 0, :delivery-min 200, :rating 4} {:logo "https://static.delivery.com/merchant_logo.php?id=75323", :cost-range 1, :name "Grandma's Kosher Pizza", :cuisines ["Kosher" "Pizza"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/grandmas-pizza", :id "75323", :delivery-fee 0, :delivery-min 15, :rating 4} {:logo "https://static.delivery.com/merchant_logo.php?id=78818", :cost-range 1, :name "Kismat", :cuisines ["Indian"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/kismat", :id "78818", :delivery-fee 1, :delivery-min 15, :rating 4} {:logo "https://static.delivery.com/merchant_logo.php?id=78927", :cost-range 2, :name "Papi's Pizzeria", :cuisines ["Italian" "Pizza"], :source :delivery, :delivery-time 25, :link "https://www.delivery.com/cities/nyc/categories/restaurant/papis-pizzeria", :id "78927", :delivery-fee 0, :delivery-min 15, :rating 4.5} {:logo "https://static.delivery.com/merchant_logo.php?id=82269", :cost-range 1, :name "Scoop Cafe", :cuisines ["Burgers" "Pizza" "Sandwiches" "Breakfast"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/scoop-cafe", :id "82269", :delivery-fee 0, :delivery-min 10, :rating 3} {:logo "https://static.delivery.com/merchant_logo.php?id=60409", :cost-range 1, :name "Empire Szechuan Noodle", :cuisines ["Chinese"], :source :delivery, :delivery-time 50, :link "https://www.delivery.com/cities/nyc/categories/restaurant/empire-szechuan-noodle", :id "60409", :delivery-fee 1, :delivery-min 10, :rating 3.5} {:logo "https://static.delivery.com/merchant_logo.php?id=84430", :cost-range 1, :name "La Pinata Mexican Cuisine", :cuisines ["Latin" "Mexican" "Vegetarian"], :source :delivery, :delivery-time 30, :link "https://www.delivery.com/cities/nyc/categories/restaurant/la-pinata-mexican-cuisine", :id "84430", :delivery-fee 0, :delivery-min 15, :rating 3} {:logo "https://static.delivery.com/merchant_logo.php?id=1579", :cost-range 3, :name "Katz's Delicatessen", :cuisines ["Deli" "Sandwiches"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/katzs-delicatessen-restaurant", :id "1579", :delivery-fee 30, :delivery-min 100, :rating 4.5} {:logo "https://static.delivery.com/merchant_logo.php?id=82833", :cost-range 1, :name "Kennedy Fried Chicken and Pizza", :cuisines ["American" "Pizza" "Wings" "Chicken"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/bronx/categories/restaurant/kennedy-fried-chicken-and-pizza-grand-concourse", :id "82833", :delivery-fee 5, :delivery-min 10, :rating 3.5} {:logo "https://static.delivery.com/merchant_logo.php?id=82785", :cost-range 1, :name "Ess-A-Bagel", :cuisines ["Bagels" "Deli" "Sandwiches" "Desserts"], :source :delivery, :delivery-time 75, :link "https://www.delivery.com/cities/nyc/categories/restaurant/ess-a-bagel-3rd-ave", :id "82785", :delivery-fee 35, :delivery-min 100, :rating 3.5} {:logo "https://static.delivery.com/merchant_logo.php?id=86789", :cost-range 1, :name "Noel's Pizza", :cuisines ["Italian" "Pizza" "Sandwiches"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/noels-pizza", :id "86789", :delivery-fee 0, :delivery-min 12, :rating 4.5} {:logo "https://static.delivery.com/merchant_logo.php?id=86810", :cost-range 2, :name "Riossi Pizza", :cuisines ["Italian" "Pizza"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/riossi-pizza", :id "86810", :delivery-fee 1, :delivery-min 10, :rating 3.5} {:logo "https://static.delivery.com/merchant_logo.php?id=60704", :cost-range 2, :name "Long Grain Thai & Japanese", :cuisines ["Thai" "Japanese"], :source :delivery, :delivery-time 60, :link "https://www.delivery.com/cities/nyc/categories/restaurant/long-grain-thai-japanese", :id "60704", :delivery-fee 2, :delivery-min 10, :rating 3.5} {:logo "https://static.delivery.com/merchant_logo.php?id=79384", :cost-range 2, :name "Vine Sushi & Asian Cuisine", :cuisines ["Japanese" "Sushi" "Chinese"], :source :delivery, :delivery-time 45, :link "https://www.delivery.com/cities/nyc/categories/restaurant/vine-asian-cuisine", :id "79384", :delivery-fee 2, :delivery-min 15, :rating 3.5}])


(defn app [req]
  (let [uri (req :uri)]
    (if (boolean (re-find #"(.js|.css)" uri))
      {:status 200
      ;  :headers {"Content-Type" "application/javascript"}
       :body (File. "public" uri)}
    (if (and (= uri "/search") (= (req :request-method) :post))
      (let [params (json/decode (slurp (req :body)) true)
            params-map (into {}
                          (map
                            #(hash-map (keyword (% :name))
                                       (% :value)) params))]
        {:status 200
         :headers {"Content-Type" "text/html"}
         :body (tmplts/results-template (scraper/search params-map))})
      {:status  200
       :headers {"Content-Type" "text/html"}
       :body (tmplts/page-template (tmplts/results-template sample-data))}))))

(defonce server (atom nil))

(defn stop-server []
 (when-not (nil? @server)
   (@server)
   (reset! server nil)))

(defn -main
  "I don't do a whole lot ... yet."
  [& args]
  (let [port (Integer/parseInt (env :port "8080"))]
  (reset! server (server/run-server #'app {:port port}))))
